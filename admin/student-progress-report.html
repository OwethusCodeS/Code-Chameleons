<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Report</title>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap");

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Poppins", sans-serif;
        }

        body {
            min-height: 100vh;
            background: #F0F4FF;
            display: flex;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 85px;
            display: flex;
            overflow-x: hidden;
            flex-direction: column;
            background: #161a2d;
            padding: 25px 20px;
            transition: all 0.4s ease;
        }

        .sidebar:hover {
            width: 260px;
        }

        .sidebar li.active {
            background-color: #00aaff;
        }

        .sidebar .sidebar-header {
            display: flex;
            align-items: center;
        }

        .sidebar .sidebar-header h2 {
            color: #fff;
            font-size: 1.25rem;
            font-weight: 600;
            white-space: nowrap;
            margin-left: 23px;
        }

        .sidebar-links h4 {
            color: #fff;
            font-weight: 500;
            white-space: nowrap;
            margin: 10px 0;
            position: relative;
        }

        .sidebar-links h4 span {
            opacity: 0;
        }

        .sidebar:hover .sidebar-links h4 span {
            opacity: 1;
        }

        .sidebar-links .menu-separator {
            position: absolute;
            left: 0;
            top: 50%;
            width: 100%;
            height: 1px;
            transform: scaleX(1);
            transform: translateY(-50%);
            background: #4f52ba;
            transform-origin: right;
            transition-delay: 0.2s;
        }

        .sidebar:hover .sidebar-links .menu-separator {
            transition-delay: 0s;
            transform: scaleX(0);
        }

        .sidebar-links {
            list-style: none;
            margin-top: 20px;
            height: 80%;
            overflow-y: auto;
            scrollbar-width: none;
        }

        .sidebar-links::-webkit-scrollbar {
            display: none;
        }

        .sidebar-links li a {
            display: flex;
            align-items: center;
            gap: 0 20px;
            color: #fff;
            font-weight: 500;
            white-space: nowrap;
            padding: 15px 10px;
            text-decoration: none;
            transition: 0.2s ease;
        }

        .sidebar-links li a:hover {
            color: #161a2d;
            background: #fff;
            border-radius: 4px;
        }

        .user-account {
            margin-top: auto;
            padding: 12px 10px;
            margin-left: -10px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            color: #161a2d;
        }

        .user-profile img {
            width: 42px;
            border-radius: 50%;
            border: 2px solid #fff;
        }

        .user-profile h3 {
            font-size: 1rem;
            font-weight: 600;
        }

        .user-profile span {
            font-size: 0.775rem;
            font-weight: 600;
        }

        .user-detail {
            margin-left: 23px;
            white-space: nowrap;
        }

        .sidebar:hover .user-account {
            background: #fff;
            border-radius: 4px;
        }

        .container {
            margin-left: 85px;
            padding: 20px;
            width: calc(100% - 85px);
            background-color: white;
            border-radius: 10px;
            max-width: 1200px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: margin-left 0.4s ease;
        }

        .sidebar:hover ~ .container {
            margin-left: 260px;
            width: calc(100% - 260px);
        }

        h1 {
            color: #150578;
            margin-bottom: 20px;
        }

        .logout-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .logout-box {
            background-color: #fff;
            padding: 20px;
            width: 300px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .logout-box h3 {
            margin-bottom: 20px;
            font-size: 18px;
        }
        .logout-box button {
            padding: 10px 20px;
            margin: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .confirm-btn {
            background-color: #4285f4;
            color: white;
        }
        .cancel-btn {
            background-color: #ccc;
            color: black;
        }

        #reportForm {
            margin-bottom: 20px;
        }
        #reportForm label {
            display: block;
            margin-bottom: 5px;
        }
        #reportForm select, #reportForm input[type="date"], #reportForm button {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #reportForm button {
            background-color: #4285f4;
            color: white;
            border: none;
            cursor: pointer;
        }
        #reportForm button:hover {
            background-color: #3367d6;
        }
        #reportTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        #reportTable th, #reportTable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        #reportTable th {
            background-color: #f2f2f2;
        }
        #error {
            color: red;
            margin-bottom: 10px;
        }
        #exportButton {
            margin-top: 10px;
            padding: 10px 20px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #exportButton:hover {
            background-color: #3367d6;
        }
        #loadingIndicator {
            display: none;
            text-align: center;
            margin-top: 20px;
        }
        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }
        .radio-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .radio-group input[type="radio"] {
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-header">
          <h2></h2>
          <div class="menu-separator"></div>
        </div>
    
        <ul class="sidebar-links">
          <h4><span>Main Menu</span><div class="menu-separator"></div></h4>
          <li><a href="adminDashboard.html"><span class="material-symbols-outlined"> dashboard </span>Dashboard</a></li>
          <li><a href="userManagement.html"><span class="material-symbols-outlined"> person </span>User Management</a></li>
          <li><a href="announcements.html"><span class="material-symbols-outlined"> folder </span>Announcements</a></li>
          <li><a href="calendar-admin.html" class="active"><span class="material-symbols-outlined">calendar_month</span>Calendar Management</a></li>
          <li><a href="/coursematerial/upload.html"><span class="material-symbols-outlined">school</span>Course Management</a></li>
          <li><a href="/admin/adminCode.html"><span class="material-symbols-outlined">person</span>Admin Code</a></li>
          <li><a href="/admin/student-progress-report.html" id="studentReportLink"><span class="material-symbols-outlined">assessment</span>Student Report</a></li>
    
          <h4><span></span>User Page<div class="menu-separator"></div></h4>
         <li><a href="/user/dashboard.html"><span class="material-symbols-outlined"> dashboard </span>Student Dashboard</a></li>
    
         <h4><span>Logout</span><div class="menu-separator"></div></h4>
          <li><a href="/signup/signup.html"><span class="material-symbols-outlined"> logout </span>Logout</a></li>
        </ul>
              </div>
            </div>
          </div>
        </ul>
      </aside>

    <div class="container">
        <h1>Student Progress Report</h1>
        <div id="studentReportContent">
            <form id="reportForm">
                <div class="radio-group">
                    <label>
                        <input type="radio" name="reportType" value="single" checked> Single Student
                    </label>
                    <label>
                        <input type="radio" name="reportType" value="all"> All Students
                    </label>
                </div>

                <div id="studentSelectContainer">
                    <label for="studentSelect">Select Student:</label>
                    <select id="studentSelect" required>
                        <option value="">Choose a student</option>
                    </select>
                </div>
                
                <label for="startDate">Start Date:</label>
                <input type="date" id="startDate" required>
                
                <label for="endDate">End Date:</label>
                <input type="date" id="endDate" required>
                
                <button type="submit">Generate Report</button>
            </form>
            
            <div id="error"></div>
            <div id="loadingIndicator">Loading...</div>
            
            <table id="reportTable" style="display:none;">
                <thead>
                    <tr>
                        <th>Student</th>
                        <th>Date</th>
                        <th>Total Trades</th>
                        <th>Win Rate (%)</th>
                        <th>Loss Rate (%)</th>
                        <th>Profit Factor</th>
                    </tr>
                </thead>
                <tbody id="reportBody"></tbody>
            </table>
            
            <button id="exportButton" style="display:none;">Export to Excel</button>
        </div>
    </div>

    <div class="logout-overlay" id="logoutOverlay">
        <div class="logout-box">
            <h3>Are you sure you want to log out?</h3>
            <button class="confirm-btn" onclick="confirmLogout()">Yes, Log Out</button>
            <button class="cancel-btn" onclick="hideLogoutOverlay()">Cancel</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCaNzDsBYR5W3ilBn5WjpkL3JkXU-toNss",
            authDomain: "closingclients-6afd9.firebaseapp.com",
            projectId: "closingclients-6afd9",
            storageBucket: "closingclients-6afd9.appspot.com",
            messagingSenderId: "172719805662",
            appId: "1:172719805662:web:00f3153c44758dade75e4f"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let reportData = [];
        let allUsers = [];

        auth.onAuthStateChanged((user) => {
            if (user) {
                fetchUsers();
            } else {
                window.location.href = '/signup/signup.html';
            }
        });

        function fetchUsers() {
            db.collection('users').get().then((snapshot) => {
                const select = document.getElementById('studentSelect');
                allUsers = snapshot.docs.map(doc => ({
                    id: doc.id,
                    name: doc.data().name || 'Unknown User'
                }));
                allUsers.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.name;
                    select.appendChild(option);
                });
            }).catch((error) => {
                showError("Error fetching users: " + error.message);
            });
        }

        document.querySelectorAll('input[name="reportType"]').forEach((elem) => {
            elem.addEventListener("change", function(event) {
                document.getElementById('studentSelectContainer').style.display = 
                    event.target.value === 'single' ? 'block' : 'none';
            });
        });

        document.getElementById('reportForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const reportType = document.querySelector('input[name="reportType"]:checked').value;
            const studentId = document.getElementById('studentSelect').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if ((reportType === 'single' && !studentId) || !startDate || !endDate) {
                showError("Please fill in all required fields.");
                return;
            }

            if (reportType === 'single') {
                generateReport(studentId, startDate, endDate);
            } else {
                generateAllStudentsReport(startDate, endDate);
            }
        });

        function generateReport(studentId, startDate, endDate) {
            showLoading(true);
            db.collection(`users/${studentId}/tradingData`)
                .orderBy('date', 'desc')
                .get()
                .then((snapshot) => {
                    const startTimestamp = new Date(startDate).getTime();
                    const endTimestamp = new Date(endDate).getTime();
                    
                    reportData = snapshot.docs
                        .map(doc => {
                            const data = doc.data();
                            let date = data.date && data.date.toDate ? data.date.toDate() : new Date(data.date);
                            return {
                                studentId: studentId,
                                studentName: allUsers.find(u => u.id === studentId).name,
                                date: date,
                                totalTrades: data.totalTrades || 0,
                                winRate: data.winRate || 0,
                                lossRate: data.lossRate || 0,
                                profitFactor: data.profitFactor || 0
                            };
                        })
                        .filter(data => {
                            const dataTimestamp = data.date.getTime();
                            return dataTimestamp >= startTimestamp && dataTimestamp <= endTimestamp;
                        });

                    displayReport(reportData);
                    showLoading(false);
                })
                .catch((error) => {
                    showError("Error generating report: " + error.message);
                    showLoading(false);
                });
        }

        function generateAllStudentsReport(startDate, endDate) {
            showLoading(true);
            reportData = [];
            let promises = allUsers.map(user => 
                db.collection(`users/${user.id}/tradingData`)
                    .orderBy('date', 'desc')
                    .get()
                    .then(snapshot => {
                        const startTimestamp = new Date(startDate).getTime();
                        const endTimestamp = new Date(endDate).getTime();
                        
                        const userData = snapshot.docs
                            .map(doc => {
                                const data = doc.data();
                                let date = data.date && data.date.toDate ? data.date.toDate() : new Date(data.date);
                                return {
                                    studentId: user.id,
                                    studentName: user.name,
                                    date: date,
                                    totalTrades: data.totalTrades || 0,
                                    winRate: data.winRate || 0,
                                    lossRate: data.lossRate || 0,
                                    profitFactor: data.profitFactor || 0
                                };
                            })
                            .filter(data => {
                                const dataTimestamp = data.date.getTime();
                                return dataTimestamp >= startTimestamp && dataTimestamp <= endTimestamp;
                            });
                        
                        reportData = reportData.concat(userData);
                    })
            );

            Promise.all(promises)
                .then(() => {
                    displayReport(reportData);
                    showLoading(false);
                })
                .catch((error) => {
                    showError("Error generating report: " + error.message);
                    showLoading(false);
                });
        }

        function displayReport(data) {
            const tbody = document.getElementById('reportBody');
            tbody.innerHTML = '';

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.studentName}</td>
                    <td>${row.date.toLocaleDateString()}</td>
                    <td>${row.totalTrades}</td>
                    <td>${row.winRate}</td>
                    <td>${row.lossRate}</td>
                    <td>${row.profitFactor}</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('reportTable').style.display = 'table';
            document.getElementById('exportButton').style.display = 'block';
        }

        document.getElementById('exportButton').addEventListener('click', function() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Student,Date,Total Trades,Win Rate (%),Loss Rate (%),Profit Factor\n";

            reportData.forEach(row => {
                csvContent += `${row.studentName},${row.date.toLocaleDateString()},${row.totalTrades},${row.winRate},${row.lossRate},${row.profitFactor}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "student_progress_report.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        function showError(message) {
            document.getElementById('error').textContent = message;
        }

        function showLoading(isLoading) {
            document.getElementById('loadingIndicator').style.display = isLoading ? 'block' : 'none';
            document.getElementById('reportForm').style.display = isLoading ? 'none' : 'block';
        }

        function showLogoutOverlay() {
            document.getElementById('logoutOverlay').style.display = 'flex';
        }

        function hideLogoutOverlay() {
            document.getElementById('logoutOverlay').style.display = 'none';
        }

        function confirmLogout() {
            auth.signOut().then(() => {
                window.location.href = '/signup/signup.html';
            }).catch((error) => {
                console.error("Error signing out: ", error);
            });
        }
    </script>
</body>
</html>