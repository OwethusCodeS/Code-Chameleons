<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard</title>
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap");

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Poppins", sans-serif;
    }

    body {
      min-height: 100vh;
      background: #F0F4FF;
      display: flex;
    }

    /* Container Layout */
    .container {
      margin-left: 85px;
      padding: 20px;
      width: calc(100% - 85px);
      background-color: white;
      border-radius: 10px;
      max-width: 1200px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      width: 85px;
      display: flex;
      flex-direction: column;
      background: #161a2d;
      padding: 25px 20px;
      transition: width 0.3s ease;
    }

    .sidebar:hover {
      width: 260px;
    }

    .sidebar li.active {
      background-color: #00aaff;
    }

    /* Sidebar Header */
    .sidebar .sidebar-header {
      display: flex;
      align-items: center;
    }

    .sidebar .sidebar-header h2 {
      color: #fff;
      font-size: 1.25rem;
      font-weight: 600;
      white-space: nowrap;
      margin-left: 23px;
    }

    .sidebar-links h4 {
      color: #fff;
      font-weight: 500;
      white-space: nowrap;
      margin: 10px 0;
      position: relative;
    }

    .sidebar-links h4 span {
      opacity: 0;
    }

    .sidebar:hover .sidebar-links h4 span {
      opacity: 1;
    }

    /* Sidebar Menu Separator */
    .sidebar-links .menu-separator {
      position: absolute;
      left: 0;
      top: 50%;
      width: 100%;
      height: 1px;
      transform: scaleX(1);
      transform: translateY(-50%);
      background: #4f52ba;
      transform-origin: right;
      transition-delay: 0.2s;
    }

    .sidebar:hover .sidebar-links .menu-separator {
      transition-delay: 0s;
      transform: scaleX(0);
    }

    .sidebar-links {
      list-style: none;
      margin-top: 20px;
      height: 80%;
      overflow-y: auto;
      scrollbar-width: none;
    }

    .sidebar-links::-webkit-scrollbar {
      display: none;
    }

    .sidebar-links li a {
      display: flex;
      align-items: center;
      gap: 0 20px;
      color: #fff;
      font-weight: 500;
      white-space: nowrap;
      padding: 15px 10px;
      text-decoration: none;
      transition: 0.2s ease;
    }

    .sidebar-links li a:hover {
      color: #161a2d;
      background: #fff;
      border-radius: 4px;
    }

    /* User Account Section */
    .user-account {
      margin-top: auto;
      padding: 12px 10px;
      margin-left: -10px;
    }

    .user-profile {
      display: flex;
      align-items: center;
      color: #161a2d;
    }

    .user-profile img {
      width: 42px;
      border-radius: 50%;
      border: 2px solid #fff;
    }

    .user-profile h3 {
      font-size: 1rem;
      font-weight: 600;
    }

    .user-profile span {
      font-size: 0.775rem;
      font-weight: 600;
    }

    .user-detail {
      margin-left: 23px;
      white-space: nowrap;
    }

    .sidebar:hover .user-account {
      background: #fff;
      border-radius: 4px;
    }

    /* Main Content */
    .main-content {
      margin-left: 85px;
      padding: 20px;
      flex-grow: 1;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: white;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0px 2px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .header-left {
      display: flex;
      align-items: center;
    }

    .header-left h3 {
      margin-left: 10px;
      color: #333;
    }

    .header-right {
      display: flex;
      align-items: center;
    }

    .search-bar {
      padding: 8px 12px;
      border-radius: 20px;
      background-color: #f0f0f5;
      border: none;
      outline: none;
      margin-right: 15px;
    }

    .profile-pic {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-left: 15px;
    }

    /* Student Progress Styles */
    .user-data {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: white;
    }

    .chart-container {
      width: 100%;
      height: 300px;
      margin-bottom: 20px;
    }

    .data-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .latest-data, .historical-data {
      background-color: #f9f9f9;
      padding: 15px;
      border-radius: 5px;
    }

    .historical-data ul {
      max-height: 150px;
      overflow-y: auto;
      padding-left: 20px;
    }

    #error-message {
      color: red;
      font-weight: bold;
      text-align: center;
    }
                            /* Custom Logout Confirmation Box */
                            .logout-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .logout-box {
            background-color: #fff;
            padding: 20px;
            width: 300px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .logout-box h3 {
            margin-bottom: 20px;
            font-size: 18px;
        }
        .logout-box button {
            padding: 10px 20px;
            margin: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .confirm-btn {
            background-color: #4BBFB4;
            color: white;
        }
        .cancel-btn {
            background-color: #ccc;
            color: black;
        }
        .logo-img {
            width: 200px;
            margin-bottom: 30px;
            display: block;       /* Makes the image a block-level element */
            margin-left: auto;    /* Aligns the image to the left with equal margin on both sides */
            margin-right: auto;   /* Aligns the image to the right with equal margin on both sides */
        }

  </style>
</head>
<body>

  <aside class="sidebar">
    <div class="sidebar-header">
      <h2></h2>
      <div class="menu-separator"></div>
    </div>

    <ul class="sidebar-links">
      <h4><span>Main Menu</span><div class="menu-separator"></div></h4>
      <li><a href="adminDashboard.html"><span class="material-symbols-outlined"> dashboard </span>Dashboard</a></li>
      <li><a href="userManagement.html"><span class="material-symbols-outlined"> person </span>User Management</a></li>
      <li><a href="announcements.html"><span class="material-symbols-outlined"> folder </span>Announcements</a></li>
      <li><a href="calendar-admin.html" class="active"><span class="material-symbols-outlined">calendar_month</span>Calendar Management</a></li>
      <li><a href="/coursematerial/upload.html"><span class="material-symbols-outlined">school</span>Course Management</a></li>
      <li><a href="/admin/adminCode.html"><span class="material-symbols-outlined">person</span>Admin Code</a></li>
      <li><a href="/admin/student-progress-report.html" id="studentReportLink"><span class="material-symbols-outlined">assessment</span>Student Report</a></li>

      <h4><span></span>User Page<div class="menu-separator"></div></h4>
     <li><a href="/user/dashboard.html"><span class="material-symbols-outlined"> dashboard </span>Student Dashboard</a></li>

     <h4><span>Logout</span><div class="menu-separator"></div></h4>
      <li><a href="/signup/signup.html"><span class="material-symbols-outlined"> logout </span>Logout</a></li>
    </ul>
          </div>
        </div>
      </div>
    </ul>
  </aside>

  <!-- Main Dashboard Content -->
  <div class="main-content">
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <img src="CTFX.png" alt="CTFX Logo" class="logo-img">
        <h2></h2>
      </div>
      <div class="header-right">
      <!----  <input type="text" class="search-bar" placeholder="Search"> -->
      </div>
    </div>

    <!-- Student Progress Content -->
    <h1>Admin Dashboard - Student Progress</h1>
    <div id="error-message"></div>
    <div id="user-data-container"></div>
  </div>
          <!-- Logout Confirmation Overlay -->
          <div class="logout-overlay" id="logoutOverlay">
            <div class="logout-box">
                <h3>Are you sure you want to log out?</h3>
                <button class="confirm-btn" onclick="confirmLogout()">Yes, Log Out</button>
                <button class="cancel-btn" onclick="hideLogoutOverlay()">Cancel</button>
            </div>
        </div>

  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCaNzDsBYR5W3ilBn5WjpkL3JkXU-toNss",
      authDomain: "closingclients-6afd9.firebaseapp.com",
      projectId: "closingclients-6afd9",
      storageBucket: "closingclients-6afd9.appspot.com",
      messagingSenderId: "172719805662",
      appId: "1:172719805662:web:00f3153c44758dade75e4f"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let charts = {};

    function showError(message) {
      document.getElementById('error-message').textContent = message;
    }

    function createUserSection(userId, userName) {
      const userSection = document.createElement('div');
      userSection.className = 'user-data';
      userSection.innerHTML = `
        <h2>Student: ${userName}</h2>
        <div class="chart-container">
          <canvas id="chart-${userId}"></canvas>
        </div>
        <div class="data-grid">
          <div class="latest-data">
            <h3>Latest Data:</h3>
            <p id="latest-${userId}"></p>
          </div>
          <div class="historical-data">
            <h3>Historical Data:</h3>
            <ul id="history-${userId}"></ul>
          </div>
        </div>
      `;
      document.getElementById('user-data-container').appendChild(userSection);

      const ctx = document.getElementById(`chart-${userId}`).getContext('2d');
      charts[userId] = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {
              label: 'Win Rate (%)',
              data: [],
              borderColor: 'rgb(75, 192, 192)',
              tension: 0.1
            },
            {
              label: 'Profit Factor',
              data: [],
              borderColor: 'rgb(255, 99, 132)',
              tension: 0.1
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }



    function updateUserData(userId, userData) {
      const latestData = userData[0];
      const chart = charts[userId];

      if (!chart) {
                console.error(`Chart for user ${userId} not found`);
                return;
            }

      // Update chart
      chart.data.labels = userData.map(data => data.date);
      chart.data.datasets[0].data = userData.map(data => parseFloat(data.winRate));
      chart.data.datasets[1].data = userData.map(data => parseFloat(data.profitFactor));
      chart.update();

      // Update latest data
      document.getElementById(`latest-${userId}`).innerHTML = `
        Total Trades: ${latestData.totalTrades}<br>
        Win Rate: ${latestData.winRate}%<br>
        Loss Rate: ${latestData.lossRate}%<br>
        Profit Factor: ${latestData.profitFactor}
      `;

      // Update historical data
      const historyList = document.getElementById(`history-${userId}`);
      historyList.innerHTML = userData.map(data => `
        <li>${data.date}: Win Rate ${data.winRate}%, Profit Factor ${data.profitFactor}</li>
      `).join('');
    }

    function fetchAllUsersData() {
      db.collection('users').get().then((snapshot) => {
        snapshot.forEach((userDoc) => {
          const userId = userDoc.id;
          const userData = userDoc.data();
          const userName = userData.name || 'Unknown User';

          createUserSection(userId, userName);

          db.collection(`users/${userId}/tradingData`)
            .orderBy('date', 'desc')
            .onSnapshot((tradingSnapshot) => {
                const userData = tradingSnapshot.docs.map(doc => {
                   const data = doc.data();
                   return {
                       ...data,
                        date: data.date instanceof firebase.firestore.Timestamp 
                        ? data.date.toDate().toLocaleDateString() 
                        : new Date(data.date).toLocaleDateString()
                    };
                });
              updateUserData(userId, userData);
            }, (error) => {
              console.error("Error fetching trading data:", error);
              showError(`Error fetching trading data for user ${userName}: ${error.message}`);
            });
        });
      }).catch((error) => {
        console.error("Error fetching users:", error);
        showError(`Error fetching users: ${error.message}`);
      });
    }

    auth.onAuthStateChanged((user) => {
      if (user) {
        // Here you should implement your own logic to determine if the user is an admin
        // For this example, we're assuming all authenticated users are admins
        fetchAllUsersData();
      } else {
        showError("You do not have permission to view this page. Please log in as an admin.");
      }
    });
                // Function to handle logout
                function logout() {
            // Implement logout logic here
            alert('Logout clicked');
        }

        // Initial display of messages
        displayMessages();

               // Show the logout confirmation overlay
               function showLogoutOverlay() {
            document.getElementById('logoutOverlay').style.display = 'flex';
        }

        // Hide the logout confirmation overlay
        function hideLogoutOverlay() {
            document.getElementById('logoutOverlay').style.display = 'none';
        }

        // Redirect to the logout page if confirmed
        function confirmLogout() {
            window.location.href = '/signup/signup.html';
        }
  </script>
</body>
</html>